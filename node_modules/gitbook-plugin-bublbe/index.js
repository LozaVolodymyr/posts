var fs = require('fs');
var path = require('path');
var marked = require('marked');
var $ = require('jquery');

console.log($);
function showContent(e) {
						var target = event.target;
						var parent = target.parentNode;
						var hiddenDiv = parent.children[1];
						$(hiddenDiv).toggle();
						/*if (hiddenDiv.style.display == "none") { hiddenDiv.style.display = "block";}
						else {
							hiddenDiv.style.display = "none";
						}*/
						/*
						var target = event.target;
						var parent = target.parentNode;
						//console.log(hiddenDiv.style.display);
						var $parent = $(this).parent();
						console.log($parent);
						//$('.hidden_content').toggle();*/
						}
					//var postUrl = el.replace(/\w\w\/\w+?\//, '');

module.exports = {
    blocks: {
        directory:{
            process: function(bbk) {
				var path2 = bbk.body;
				//console.log(bbk);
				function fileList(dir) {
					return fs.readdirSync(dir).reduce(function(list, file) {
						if (file != 'README.md') {
							var name = path.join(dir, file);
							var isDir = fs.statSync(name).isDirectory();
							return list.concat(isDir ? fileList(name) : [name]);
						}
						else {
							return list;
						}
				}, []);
			}    
				var arrList = [];
				fileList(path2).forEach(function (el, index) {
					//console.log(el);
					var stats = fs.statSync(el);
					//console.log(stats);
					var createDate = stats.mtime;
					var string = '"'+createDate+'"';
					var arr = string.split(' ');
					//console.log(arr);
					/*switch () {
						case 'Jan' : return 1; break;
						case 'Feb' : return 2; break;
						case 'Mar' : return 3; break;
						case 'Apr' : return 4; break;
						case 'May' : return 5; break;
						case 'Jun' : return 6; break;
						case 'Jul' : return 7; break;
						case 'Aug' : return 8; break;
						case 'Sep' : return 9; break;
						case 'Oct' : return 10; break;
						case 'Nov' : return 11; break;
						case 'Dec' : return 12; break;
						
					}*/
					var postUrl = el.match(/\/[a-z0-9\-]+?\.md/i);
					postUrl = postUrl[0].replace(/\.md/, '.html');
					var element = fs.readFileSync(el, 'utf8');
					var tempElement = marked(element);
					var otherText = tempElement.match(/<p>[^<img>][\w\s\W]+?<\/p>/g);
					var hiddenContent = otherText.join('');
					var headerPost = tempElement.match(/<h1\s[\w\W]+?>[\s\S]+?<\/h1>/);
					//console.log(hideContent);
					headerPost[0] = headerPost[0].replace(/h1/g, 'h2');
					var headerText = headerPost[0].replace(/>([\w\W\s]+?)</, '><a class="archive-article-title" href="'+postUrl+'">$1</a><');
					var imgPost = tempElement.match(/<img\s[\w\W]+?>/);
					var firstParagraph = tempElement.match(/<p>[^<img>]+?<\/p>/);
					arrList.push("<div class='row'><div class='col-md-4 col-sm-4'>"+imgPost[0]+"</div><div class='col-md-8 col-sm-8'>"+headerText+"<ul class='blog-info'><li><i class='fa fa-calendar'></i><time datetime='2016-03-18T00:00:00.000Z' itemprop='datePublished'>2016/01/02</time></li><li><i class='fa fa-comments'></i><a href='"+ postUrl +"' class='article-comment-link'>0 відгуків</a></li><li><i class='fa fa-tags'></i><a href='/tags/Design/' title='Design'>Корупція, </a><a href='/tags/Programming/' title='Programming'>Україні</a></li></ul><div class='blog-item'>"+firstParagraph[0]+"<div style='display: none; width: 100%;' class='hidden_content'>"+hiddenContent+"</div><button type='button' class='btn btn-primary' onclick='showContent()'>More</button></div></div></div><hr class='blog-post-sep'>");
				})
				var tmpHtml =  "";
				//<a href='"+ postUrl +"' class='more'>Читать> <i class='icon-angle-right'></i></a>
				for (var i = 0; i < arrList.length; i++) {
					tmpHtml += arrList[i];
				}
			return tmpHtml;
            }
        }
    }
};
